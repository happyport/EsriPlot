// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/supportClasses/dataCollections/DataCollectionsLoader",["esri/dijit/geoenrichment/promise/all","../GEUtil","../ReportTemplateData","esri/dijit/geoenrichment/utils/JsonXmlConverter","esri/dijit/geoenrichment/utils/UrlUtil"],function(m,f,n,g,l){return{_cache:{},canLoad:function(){return f.canMakeRequests()},loadVariables:function(c){var e="*"===c.outFields,d=e?["*"]:c.outFields,a=c.countryID+";"+c.hierarchy+";"+d.join(";")+";"+!!c.forceLowerCase;
this._cache[a]||(e||(d=d.slice(),-1===d.indexOf("id")&&d.push("id")),this._cache[a]=f.getDataCollections(c.countryID,c.hierarchy,{f:"json",outFields:e?"*":JSON.stringify(d),suppressNullValues:!0,AddDerivativeVariables:"all"}).then(function(a){var h={dataCollections:a,idToVariableCache:{},fullNameToVariableCache:{}};a.forEach(function(b){b.data.forEach(function(a){function k(a){return c.forceLowerCase?a.toLowerCase():a}function f(a){if(e)return Object.keys(a).length;var b=0;d.forEach(function(d){void 0!==
a[d]&&b++});return b}var g=h.idToVariableCache[k(a.id)];if(!g||f(a)>f(g))h.idToVariableCache[k(a.id)]=a;h.fullNameToVariableCache[k(b.dataCollectionID+"."+a.id)]=a})});return h}));return this._cache[a]},loadCustomDataVariables:function(c,e){e=e||{};var d={idToVariableCache:{},fullNameToVariableCache:{}};return m(c.map(function(a){var c=l.combineMulti([a.url||e.portalUrl,"sharing/rest/content/items",a.itemid,"resources/metadata.xml"]);return n.loadResource(c,a.token||l.getToken(e.portalUrl)).then(function(c){c=
g.parseXml(c.data);g.queryJson(c,"Field").forEach(function(b){function c(a){return e.forceLowerCase?a.toLowerCase():a}b=b.attributes;b={id:b.Name,fullName:a.itemid+"."+b.Name,alias:b.Alias,description:b.Alias,type:"esriFieldType"+b.Type,precision:b.Precision?Number(b.Precision):void 0,vintage:b.Vintage};d.idToVariableCache[c(b.id)]=b;d.fullNameToVariableCache[c(b.fullName)]=b})})})).then(function(){return d})}}});