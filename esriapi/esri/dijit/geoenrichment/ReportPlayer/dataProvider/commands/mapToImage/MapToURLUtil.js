// All material copyright ESRI, All Rights Reserved, unless otherwise specified.
// See http://js.arcgis.com/3.30/esri/copyright.txt for details.
//>>built
define("esri/dijit/geoenrichment/ReportPlayer/dataProvider/commands/mapToImage/MapToURLUtil","require dojo/_base/declare esri/dijit/geoenrichment/Deferred esri/dijit/geoenrichment/when esri/dijit/geoenrichment/promise/all dojo/dom-style esri/dijit/geoenrichment/utils/UrlUtil esri/dijit/geoenrichment/utils/ImageInfoUtil".split(" "),function(v,w,l,h,x,m,y,z){function A(){var a=new l;v("esri/tasks/PrintTask esri/tasks/PrintParameters esri/tasks/PrintTemplate esri/layers/GraphicsLayer ./DotDensityToImageUtil ./LegendToLayerUtil".split(" "),
function(b,d,e,B,f,c){n=d;p=e;q=B;k=f;r=c;t=w(b,{_getPrintDefinition:function(a,b){var d=this.inherited(arguments);console.log(d);return d},_createOperationalLayers:function(a,b){var d=this.inherited(arguments);if(b.__legendLayerId){var f=d.filter(function(a){return a.id===b.__legendLayerId})[0];d.splice(d.indexOf(f),1);d.push(f)}return d}});a.resolve()});return a.promise}var t,n,p,q,k,r,u,c={setPrintMapTaskUrl:function(a){u=a;y.registerCORS(a)},mapToURL:function(a,b,d){var e=c._getUrlForMap(a);if(e)return e;
e=A().then(function(){return c._replaceDotDensityLayersWithPictureMarkers(a).then(function(e){return h(b&&r.legendToGraphicsLayer(b,a,d),function(b){b&&a.addLayer(b);return h(c._runPrintTask(a,d,b),function(d){b&&a.removeLayer(b);c._rollbackReplacing(a,e);var f=new l;setTimeout(function(){f.resolve(d.url)},100);return f.promise})})})});c._putUrlToCache(a,e);return e},_replaceDotDensityLayersWithPictureMarkers:function(a){var b=[];for(i=0;i<a.graphicsLayerIds.length;i++)layer=a.getLayer(a.graphicsLayerIds[i]),
layer.loaded&&layer.visible&&k.isDotDensity(layer)&&b.push(c._createGraphicsLayerFromDotDensityLayer(i,layer,a));return x(b)},_createGraphicsLayerFromDotDensityLayer:function(a,b,d){return k.createPictureMarkersFromDotDensityLayer(b,d.extent,d).then(function(e){if(!e)return null;var c=new q;e.map(function(a){c.add(a)});d.addLayer(c,a);b.visible=!1;return{addedLayer:c,hiddenLayer:b}}).otherwise(function(a){console.log(a);return null})},_runPrintTask:function(a,b,d){function c(){var c=new t(u),f=new n;
f.map=a;var e=new p;e.exportOptions={width:3.125*m.get(b,"width"),height:3.125*m.get(b,"height"),dpi:300};e.format="png32";e.showAttribution=!1;e.__legendLayerId=d&&d.id;f.template=e;return c.execute(f)}return h(c(),function(a){return a},function(a){console.log(a);return h(c(),function(a){return a},function(a){console.log(a);return c()})})},_rollbackReplacing:function(a,b){b.forEach(function(b){b&&b.addedLayer&&a.removeLayer(b.addedLayer);b&&b.hiddenLayer&&(b.hiddenLayer.visible=!0)})},urlToSrc:function(a,
b){return b.saveImagesAsDataUrl?z.getRemoteImageDataUrl(a,{sizeLimit:1500}):a}},g,C=0;c.enableCaching=function(){g={}};c.clearCaching=function(){g=null};c._putUrlToCache=function(a,b){g&&b&&(a.__mapToImageUtilKey=C++,g[a.__mapToImageUtilKey]=b)};c._getUrlForMap=function(a){return g&&g[a.__mapToImageUtilKey]};return c});